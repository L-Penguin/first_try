"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools"),_dom=require("../../tools/src/dom");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(r="Object"===r&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,o=new Array(t);r<t;r++)o[r]=e[r];return o}var getRowid=_tools.UtilTools.getRowid;function insertTreeRow(n,e,t){var s=n.tableFullTreeData,a=n.afterFullData,u=n.fullDataRowIdData,c=n.fullAllDataRowIdData,r=n.treeOpts,d=r.rowField,h=r.parentField,f=r.children,m=r.mapChildren,p=t?"push":"unshift";e.forEach(function(e){var t,r,o=e[h],l=getRowid(n,e),i=o?_xeUtils.default.findTree(s,function(e){return o===e[d]},{children:m}):null;i?(t=i.item,i=(r=c[getRowid(n,t)])?r.level:0,r=t[f],(r=!_xeUtils.default.isArray(r)?t[f]=[]:r)[p](e),i={row:e,rowid:l,seq:-1,index:-1,_index:-1,$index:-1,items:r,parent:parent,level:i+1},u[l]=i,c[l]=i):("development"===process.env.NODE_ENV&&o&&_tools.UtilTools.warn("vxe.error.unableInsert"),a[p](e),s[p](e),e={row:e,rowid:l,seq:-1,index:-1,_index:-1,$index:-1,items:s,parent:null,level:0},u[l]=e,c[l]=e)})}var _default={methods:{_insert:function(e){return this.insertAt(e)},_insertAt:function(e,t){var o=this,r=this.tableFullTreeData,l=this.mergeList,i=this.afterFullData,n=this.editStore,s=this.tableFullData,a=this.treeConfig,u=this.fullDataRowIdData,c=this.fullAllDataRowIdData,d=this.treeOpts,h=d.transform,f=d.rowField,m=d.mapChildren,p=(e=!_xeUtils.default.isArray(e)?[e]:e).map(function(e){return o.defineField(Object.assign({},e))});if(t)if(-1===t)a&&h?insertTreeRow(this,p,!0):(i.push.apply(i,_toConsumableArray(p)),s.push.apply(s,_toConsumableArray(p)),l.forEach(function(e){var t=e.row,r=e.rowspan;t+r>i.length&&(e.rowspan=r+p.length)}));else if(a&&h){var v,w,_,C=_xeUtils.default.findTree(r,function(e){return t[f]===e[f]},{children:m});C?(v=C.parent,w=C.items,m=c[getRowid(this,v)],_=m?m.level:0,p.forEach(function(e,t){var r=getRowid(o,e);"development"===process.env.NODE_ENV&&e[d.parentField]&&v&&e[d.parentField]!==v[f]&&_tools.UtilTools.error("vxe.error.errProp",["".concat(d.parentField,"=").concat(e[d.parentField]),"".concat(d.parentField,"=").concat(v[f])]),v&&(e[d.parentField]=v[f]),w.splice(C.index+t,0,e);e={row:e,rowid:r,seq:-1,index:-1,_index:-1,$index:-1,items:w,parent:v,level:_+1};u[r]=e,c[r]=e})):("development"===process.env.NODE_ENV&&_tools.UtilTools.warn("vxe.error.unableInsert"),insertTreeRow(this,p,!0))}else{if(a)throw new Error(_tools.UtilTools.getLog("vxe.error.noTree",["insert"]));var g=-1;if(_xeUtils.default.isNumber(t)?t<i.length&&(g=t):g=i.indexOf(t),-1===g)throw new Error(_tools.UtilTools.error("vxe.error.unableInsert"));i.splice.apply(i,[g,0].concat(_toConsumableArray(p))),s.splice.apply(s,[s.indexOf(t),0].concat(_toConsumableArray(p))),l.forEach(function(e){var t=e.row,r=e.rowspan;g<t?e.row=t+p.length:g<t+r&&(e.rowspan=r+p.length)})}else a&&h?insertTreeRow(this,p,!1):(i.unshift.apply(i,_toConsumableArray(p)),s.unshift.apply(s,_toConsumableArray(p)),l.forEach(function(e){var t=e.row;0<t&&(e.row=t+p.length)}));return(n=n.insertList).unshift.apply(n,_toConsumableArray(p)),this.handleTableData(a&&h),a&&h||this.updateAfterDataIndex(),this.updateFooter(),this.cacheRowMap(),this.checkSelectionStatus(),this.scrollYLoad&&this.updateScrollYSpace(),this.$nextTick().then(function(){return o.updateCellAreas(),o.recalculate()}).then(function(){return{row:p.length?p[p.length-1]:null,rows:p}})},_remove:function(e){var o=this,l=this.afterFullData,r=this.tableFullData,i=this.tableFullTreeData,t=this.treeConfig,n=this.mergeList,s=this.editStore,a=this.checkboxOpts,u=this.selection,c=this.isInsertByRow,d=this.treeOpts,h=d.transform,f=s.actived,m=s.removeList,p=s.insertList,a=a.checkField,v=[];return e?_xeUtils.default.isArray(e)||(e=[e]):e=r,e.forEach(function(e){c(e)||m.push(e)}),a||e.forEach(function(e){e=u.indexOf(e);-1<e&&u.splice(e,1)}),r===e?(e=v=r.slice(0),this.tableFullData=[],this.afterFullData=[],this.clearMergeCells()):t&&h?e.forEach(function(e){var t=getRowid(o,e),r=_xeUtils.default.findTree(i,function(e){return t===getRowid(o,e)},d);r&&(r=r.items.splice(r.index,1),v.push(r[0]));e=l.indexOf(e);-1<e&&l.splice(e,1)}):e.forEach(function(e){var t=r.indexOf(e);-1<t&&(t=r.splice(t,1),v.push(t[0]));var o=l.indexOf(e);-1<o&&(n.forEach(function(e){var t=e.row,r=e.rowspan;o<t?e.row=t-1:o<t+r&&(e.rowspan=r-1)}),l.splice(o,1))}),f.row&&-1<e.indexOf(f.row)&&this.clearActived(),e.forEach(function(e){e=p.indexOf(e);-1<e&&p.splice(e,1)}),this.handleTableData(t&&h),t&&h||this.updateAfterDataIndex(),this.updateFooter(),this.cacheRowMap(),this.checkSelectionStatus(),this.scrollYLoad&&this.updateScrollYSpace(),this.$nextTick().then(function(){return o.updateCellAreas(),o.recalculate()}).then(function(){return{row:v.length?v[v.length-1]:null,rows:v}})},_removeCheckboxRow:function(){var t=this;return this.remove(this.getCheckboxRecords()).then(function(e){return t.clearCheckboxRow(),e})},_removeRadioRow:function(){var t=this,e=this.getRadioRecord();return this.remove(e||[]).then(function(e){return t.clearRadioRow(),e})},_removeCurrentRow:function(){var t=this,e=this.getCurrentRecord();return this.remove(e||[]).then(function(e){return t.clearCurrentRow(),e})},_getRecordset:function(){return{insertRecords:this.getInsertRecords(),removeRecords:this.getRemoveRecords(),updateRecords:this.getUpdateRecords()}},_getInsertRecords:function(){var r=this,e=this.treeConfig,o=this.tableFullTreeData,t=this.tableFullData,l=this.treeOpts,i=this.editStore.insertList,n=[];return i.length&&(e&&l.transform?i.forEach(function(e){var t=getRowid(r,e);_xeUtils.default.findTree(o,function(e){return t===getRowid(r,e)},l)&&n.push(e)}):i.forEach(function(e){-1<t.indexOf(e)&&n.push(e)})),n},_getRemoveRecords:function(){return this.editStore.removeList},_getUpdateRecords:function(){var e=this.keepSource,t=this.tableFullData,r=this.isUpdateByRow,o=this.treeConfig,l=this.treeOpts,i=this.editStore;if(e){e=i.actived,i=e.row,e=e.column;return(i||e)&&this._syncActivedCell(),o?_xeUtils.default.filterTree(t,function(e){return r(e)},l):t.filter(function(e){return r(e)})}return[]},handleActived:function(e,t){var r,o=this,l=this.editStore,i=this.editOpts,n=this.tableColumn,s=this.editConfig,a=this.mouseConfig,u=i.mode,c=i.activeMethod,d=l.actived,h=e.row,f=e.column,i=f.editRender,l=e.cell=e.cell||this.getCell(h,f);return(0,_tools.isEnableConf)(s)&&(0,_tools.isEnableConf)(i)&&l&&(d.row!==h||"cell"===u&&d.column!==f?(r="edit-disabled",c&&!c(e)||(a&&(this.clearSelected(t),this.clearCellAreas(t),this.clearCopyCellArea(t)),this.closeTooltip(),this.clearActived(t),r="edit-actived",f.renderHeight=l.offsetHeight,d.args=e,d.row=h,d.column=f,"row"===u?n.forEach(function(e){return o._getColumnModel(h,e)}):this._getColumnModel(h,f),this.$nextTick(function(){o.handleFocus(e,t)})),this.emitEvent(r,{row:h,rowIndex:this.getRowIndex(h),$rowIndex:this.getVMRowIndex(h),column:f,columnIndex:this.getColumnIndex(f),$columnIndex:this.getVMColumnIndex(f)},t)):(r=d.column,a&&(this.clearSelected(t),this.clearCellAreas(t),this.clearCopyCellArea(t)),r!==f&&((a=r.model).update&&_tools.UtilTools.setCellValue(h,r,a.value),this.clearValidate()),f.renderHeight=l.offsetHeight,d.args=e,d.column=f,setTimeout(function(){o.handleFocus(e,t)})),this.focus()),this.$nextTick()},_getColumnModel:function(e,t){var r=t.model;t.editRender&&(r.value=_tools.UtilTools.getCellValue(e,t),r.update=!1)},_setColumnModel:function(e,t){var r=t.model;t.editRender&&r.update&&(_tools.UtilTools.setCellValue(e,t,r.value),r.update=!1,r.value=null)},_syncActivedCell:function(){var t=this,e=this.tableColumn,r=this.editStore,o=this.editOpts,r=r.actived,l=r.row,r=r.column;(l||r)&&("row"===o.mode?e.forEach(function(e){return t._setColumnModel(l,e)}):this._setColumnModel(l,r))},_clearActived:function(e){var t=this.editStore.actived,r=t.row,o=t.column;return(r||o)&&(this._syncActivedCell(),t.args=null,t.row=null,t.column=null,this.updateFooter(),this.emitEvent("edit-closed",{row:r,rowIndex:this.getRowIndex(r),$rowIndex:this.getVMRowIndex(r),column:o,columnIndex:this.getColumnIndex(o),$columnIndex:this.getVMColumnIndex(o)},e)),(_vXETable.default._valid?this.clearValidate():this.$nextTick()).then(this.recalculate)},_getActiveRecord:function(){var e=this.$el,t=this.editStore,r=this.afterFullData,o=t.actived,t=o.args,o=o.row;return t&&-1<r.indexOf(o)&&e.querySelectorAll(".vxe-body--column.col--actived").length?Object.assign({},t):null},_isActiveByRow:function(e){return this.editStore.actived.row===e},handleFocus:function(e){var t,r,o=e.row,l=e.column,i=e.cell,n=l.editRender;(0,_tools.isEnableConf)(n)&&(t=_vXETable.default.renderer.get(n.name),e=n.autofocus,n=n.autoselect,(r=!(r=e?i.querySelector(e):r)&&t&&t.autofocus?i.querySelector(t.autofocus):r)?(r.focus(),n?r.select():_dom.browse.msie&&((r=r.createTextRange()).collapse(!1),r.select())):this.scrollToRow(o,l))},_setActiveRow:function(e){return this.setActiveCell(e,_xeUtils.default.find(this.visibleColumn,function(e){return(0,_tools.isEnableConf)(e.editRender)}))},_setActiveCell:function(t,e){var r=this,o=this.editConfig,l=_xeUtils.default.isString(e)?this.getColumnByField(e):e;return t&&l&&(0,_tools.isEnableConf)(o)&&(0,_tools.isEnableConf)(l.editRender)?this.scrollToRow(t,!0).then(function(){var e=r.getCell(t,l);e&&(r.handleActived({row:t,rowIndex:r.getRowIndex(t),column:l,columnIndex:r.getColumnIndex(l),cell:e,$table:r}),r.lastCallTime=Date.now())}):this.$nextTick()},_setSelectCell:function(e,t){var r=this.tableData,o=this.editOpts,l=this.visibleColumn,t=_xeUtils.default.isString(t)?this.getColumnByField(t):t;return e&&t&&"manual"!==o.trigger&&(-1<(o=r.indexOf(e))&&(r=this.getCell(e,t),r={row:e,rowIndex:o,column:t,columnIndex:l.indexOf(t),cell:r},this.handleSelected(r,{}))),this.$nextTick()},handleSelected:function(e,t){var r=this,o=this.mouseConfig,l=this.mouseOpts,i=this.editOpts,n=this.editStore,s=n.actived,a=n.selected,u=e.row,c=e.column,d=o&&l.selected;return!d||a.row===u&&a.column===c||(s.row!==u||"cell"===i.mode&&s.column!==c)&&(r.clearActived(t),r.clearSelected(t),r.clearCellAreas(t),r.clearCopyCellArea(t),a.args=e,a.row=u,a.column=c,d&&r.addColSdCls(),r.focus(),t&&r.emitEvent("cell-selected",e,t)),r.$nextTick()},_getSelectedCell:function(){var e=this.editStore.selected,t=e.args,e=e.column;return t&&e?Object.assign({},t):null},_clearSelected:function(){var e=this.editStore.selected;return e.row=null,e.column=null,this.reColTitleSdCls(),this.reColSdCls(),this.$nextTick()},reColTitleSdCls:function(){var e=this.elemStore["main-header-list"];e&&_xeUtils.default.arrayEach(e.querySelectorAll(".col--title-selected"),function(e){return _tools.DomTools.removeClass(e,"col--title-selected")})},reColSdCls:function(){var e=this.$el.querySelector(".col--selected");e&&_tools.DomTools.removeClass(e,"col--selected")},addColSdCls:function(){var e=this.editStore.selected,t=e.row,e=e.column;this.reColSdCls(),t&&e&&((e=this.getCell(t,e))&&_tools.DomTools.addClass(e,"col--selected"))}}};exports.default=_default;